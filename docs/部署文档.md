# 永远酱系统部署文档

## 一、系统概述

永远酱系统是一个基于Docker容器化部署的文件分发与分享平台，支持多存储源接入、文件直链生成、下载次数统计以及完整的用户认证和权限管理功能。系统采用前后端分离架构，后端基于Node.js和Express构建，前端采用Vue 3和Vite开发，数据存储使用SQLite数据库（生产环境可迁移至PostgreSQL）。

本系统具备良好的可扩展性，允许用户根据实际需求灵活配置存储源、扩展系统功能，同时保持简洁直观的用户界面设计。系统支持断点续传、日志记录、错误处理等企业级特性，可满足中小型团队或个人的文件分享需求。

## 二、环境要求

在部署永远酱系统之前，请确保您的服务器满足以下环境要求。操作系统推荐使用Ubuntu 20.04 LTS或CentOS 7以上版本，这些系统经过充分测试且社区支持完善。Docker和Docker Compose是部署的必要条件，Docker Engine版本应不低于20.10，Docker Compose版本应不低于2.0。

硬件配置方面，系统最低需要1核CPU、1GB内存和10GB磁盘空间。考虑到实际使用中可能存储大量文件，建议配置至少2核CPU、4GB内存和50GB以上磁盘空间。网络方面需要确保服务器能够访问互联网，以便下载Docker镜像和更新软件包。如果您的服务器位于防火墙后方，请提前开放80和3000端口。

## 三、快速部署

### 3.1 准备部署目录

首先在服务器上创建项目目录并进入该目录。建议将项目放置在用户主目录下以便管理，例如使用`/opt`或`/home`目录。执行以下命令完成目录创建和进入操作：

```bash
mkdir -p /opt/forever-jiang && cd /opt/forever-jiang
```

将项目文件上传至该目录。您可以通过Git克隆、SCP传输或FTP上传等方式完成文件导入。如果使用Git，可在服务器上直接执行`git clone <repository-url>`命令获取最新代码。确保所有配置文件和源代码完整上传后，继续执行下一步操作。

### 3.2 配置环境变量

在项目根目录下创建`.env`文件，该文件用于存储系统的敏感配置信息，包括JWT密钥、数据库路径等。请根据以下模板创建并填写您的配置：

```bash
# JWT密钥，请使用随机生成的复杂字符串
JWT_SECRET=your-super-secret-jwt-key-change-in-production

# 服务器端口
PORT=3000

# 运行环境
NODE_ENV=production

# CORS跨域配置
CORS_ORIGIN=http://localhost

# 日志级别
LOG_LEVEL=info
```

强烈建议将`JWT_SECRET`替换为至少32位的随机字符串，可使用`openssl rand -hex 32`命令生成。生产环境中请勿使用默认值，并妥善保管该密钥，泄露可能导致用户会话被伪造。

### 3.3 构建并启动容器

环境配置完成后，执行Docker Compose命令构建和启动所有服务。该命令将自动拉取基础镜像、安装依赖、构建应用程序并启动容器。首次构建可能需要较长时间，请耐心等待：

```bash
docker-compose build --no-cache
docker-compose up -d
```

构建完成后，使用以下命令检查所有容器的运行状态。正常情况下，您应该看到backend和frontend两个容器均处于Up状态：

```bash
docker-compose ps
```

如果容器启动失败，可通过以下命令查看详细日志进行问题排查：

```bash
docker-compose logs -f
```

### 3.4 验证部署结果

服务启动后，通过浏览器访问`http://<服务器IP地址>`验证前端页面是否正常加载。首次访问时，系统会显示注册页面，您可以创建第一个管理员账户。如果页面无法打开，请检查防火墙设置是否允许80端口访问，以及Docker容器是否正常运行。

后端API服务的健康检查接口位于`http://<服务器IP地址>/api/health`，返回状态码200表示服务正常运行。同时建议测试文件上传、下载等功能以确保系统各项功能正常。

## 四、详细配置说明

### 4.1 数据库配置

系统默认使用SQLite数据库，数据文件存储在`backend/data/forever_jiang.db`。该配置适用于中小规模使用场景，无需额外配置数据库服务。如果您预计会有较高的并发访问量或需要更强大的数据库功能，可将数据迁移至PostgreSQL。

迁移至PostgreSQL需要修改后端代码中的数据库连接配置。首先安装PostgreSQL依赖包，然后在环境变量中配置数据库连接信息。具体操作步骤如下：首先在PostgreSQL中创建数据库和用户，然后修改`backend/src/database/index.ts`文件中的数据库连接逻辑，最后更新Docker Compose配置添加PostgreSQL服务。迁移过程中请注意备份原有数据。

### 4.2 存储配置

系统默认使用本地文件系统存储上传的文件，文件保存在`backend/uploads`目录。生产环境中建议使用对象存储服务以获得更好的扩展性和可靠性。目前系统已支持阿里云盘、腾讯云COS、华为云OBS和OneDrive等主流云存储服务。

添加云存储源需要通过前端界面或API进行配置。以阿里云盘为例，您需要在阿里云开发者平台创建应用并获取Access Token和Refresh Token，然后在存储源管理页面添加阿里云盘配置。配置信息将加密存储以确保安全性。请妥善保管您的云存储凭证，避免泄露导致数据安全风险。

### 4.3 性能优化

对于高并发使用场景，可通过以下方式进行性能优化。首先考虑启用GZIP压缩以减少网络传输量，该功能已在Nginx配置中启用。其次可以配置反向代理缓存，将静态资源和API响应缓存以减轻后端压力。此外还可以调整Docker容器的资源限制，为后端服务分配更多CPU和内存资源。

如果文件数量较多导致查询性能下降，建议定期清理不再需要的文件和下载日志。您可以通过设置文件过期时间让系统自动管理过期文件，也可以手动执行清理操作。数据库层面可以使用`VACUUM`命令优化SQLite数据库性能。

## 五、系统使用指南

### 5.1 用户注册与登录

首次访问系统时，您需要创建一个账户。点击页面底部的"立即注册"链接进入注册页面，填写用户名、邮箱和密码后提交即可完成注册。注册成功后系统会自动登录并跳转到仪表盘页面。建议使用真实的邮箱地址以便接收系统通知和找回密码。

已注册用户可直接在登录页面输入用户名或邮箱和密码进行登录。登录成功后系统会颁发JWT令牌用于后续请求的身份验证。令牌有效期为7天，过期后需要重新登录。如果忘记密码，需要联系系统管理员进行密码重置。

### 5.2 文件上传与管理

登录后进入"文件管理"页面，点击页面右上角的"上传文件"按钮选择要上传的文件。系统支持拖拽上传和点击选择两种方式，单次可上传多个文件。上传过程中会显示进度条，上传完成后文件将立即出现在文件列表中。

文件列表以卡片形式展示，每个卡片显示文件名、文件大小、下载次数和上传时间。点击文件卡片可进入文件详情页面，在详情页面可以下载文件、复制分享链接、设置文件公开或私有状态，以及删除不需要的文件。已公开的文件可以通过链接直接下载，无需登录账户。

### 5.3 直链生成与分享

在文件详情页面点击"生成分享链接"按钮可获取文件的直接下载链接。该链接有效期为24小时，过期后需要重新生成。链接一旦生成即被记录，您可以在下载日志中查看链接的使用情况。

生成的直链支持断点续传，下载大文件时如果中断可从断点处继续而无需重新下载。直链包含身份验证信息，请勿将链接分享到公开场所以防止未授权访问。如需长期分享，建议定期更新链接或设置文件为公开访问状态。

### 5.4 存储源管理

在"存储源"页面可以管理您的文件存储位置。默认使用本地存储，您也可以添加云存储服务。添加云存储源需要提供相应的API凭证，系统会加密保存这些信息。设置为默认存储源后，所有新上传的文件将默认存储到该位置。

支持多种存储源便于数据备份和跨平台访问。建议至少配置两种不同的存储源，将重要文件同时存储到本地和云端以提高数据安全性。需要注意的是，删除存储源前必须先将使用该存储源的文件迁移或删除。

## 六、运维维护

### 6.1 日志管理

系统日志默认保存在`backend/logs`目录下，包括错误日志和综合日志。生产环境建议定期检查日志文件，及时发现和处理异常情况。Docker容器内的日志可通过`docker-compose logs`命令查看，日志会自动轮转以控制磁盘占用。

日志级别默认为info，您可以通过环境变量`LOG_LEVEL`调整为debug以获取更详细的调试信息，或调整为warn或error以减少日志输出。建议生产环境使用info级别，既能记录必要信息又不会产生过多日志。

### 6.2 数据备份

数据备份是系统运维的重要环节，建议制定定期备份策略。SQLite数据库文件位于`backend/data/forever_jiang.db`，直接复制该文件即可完成备份。文件上传目录位于`backend/uploads`，包含所有用户上传的原始文件。

可使用cron任务实现自动备份，例如每天凌晨2点执行备份脚本。备份脚本应包含数据库导出和文件目录压缩两个步骤，备份文件应存储到独立于主服务器的存储位置。建议保留最近30天的备份，并定期将备份文件同步到异地存储以防止灾难性数据丢失。

### 6.3 数据恢复

发生数据丢失或系统故障时，可通过备份恢复数据。首先停止Docker容器服务，然后将备份的数据库文件恢复到`backend/data/`目录，将备份的上传文件恢复到`backend/uploads/`目录。完成文件恢复后重启容器服务即可恢复正常运行。

如果仅需恢复单个文件，可在文件管理页面查看历史记录或从云存储源重新下载。系统不提供版本控制功能，文件被覆盖或删除后将无法恢复，请谨慎操作。

### 6.4 版本更新

当有新版本发布时，需要按照以下步骤进行更新。首先停止当前运行的服务，然后拉取最新代码或上传更新后的文件。执行`docker-compose build --no-cache`命令重新构建镜像，构建完成后使用`docker-compose up -d`启动服务。

更新过程中注意备份当前数据和配置文件，避免更新失败导致数据丢失。重大版本更新可能涉及数据库结构变更，请查阅更新日志中的迁移说明，按需执行数据库迁移脚本。更新后建议先在测试环境验证功能正常后再部署到生产环境。

## 七、故障排除

### 7.1 常见问题

容器启动失败可能由多种原因引起。首先检查Docker服务是否正常运行，然后确认端口3000和80未被其他程序占用。查看容器日志是定位问题的有效方法，执行`docker-compose logs backend`可查看后端服务的详细日志。

文件上传失败通常与权限或磁盘空间有关。确认`backend/uploads`目录有足够的写入权限，同时检查服务器磁盘空间是否充足。如果使用云存储，检查云存储API凭证是否有效以及网络连接是否正常。

### 7.2 性能问题

页面加载缓慢可能是网络或后端性能问题。首先检查服务器带宽是否充足，然后查看后端服务的响应时间和数据库查询性能。使用浏览器开发者工具分析页面加载瀑布图，定位具体是静态资源加载还是API响应导致缓慢。

数据库查询慢可使用`EXPLAIN QUERY PLAN`命令分析SQL语句执行计划。为常用字段添加索引可以显著提升查询性能，但需要注意索引会占用额外磁盘空间并降低写入性能。

## 八、卸载与清理

### 8.1 完全卸载

如需完全卸载永远酱系统，请按以下步骤执行。首先停止并删除所有Docker容器，然后删除Docker镜像和关联的网络配置。接着删除项目目录、数据库文件、上传文件和日志文件。最后清理Docker卷和构建缓存。

执行以下命令完成彻底清理：

```bash
docker-compose down -v
docker rmi forever-jiang-backend forever-jiang-frontend
rm -rf /opt/forever-jiang
docker system prune -a
```

### 8.2 部分清理

如需保留数据仅清理临时文件，可执行以下操作。清理日志文件保留数据库和上传文件：

```bash
rm -rf backend/logs/*
```

清理过期文件需要先查询数据库中的过期记录，然后删除对应的物理文件。执行前请确认这些文件确实不再需要，因为删除操作不可恢复。
